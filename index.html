<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Valkyz AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b0f;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --text:#eaeaf2;
      --muted: rgba(255,255,255,.62);

      /* aksen merah */
      --accent:#ff3b3b;
      --accent2:#ff5c5c;

      --ai: rgba(20,20,28,.92);
      --shadow: 0 18px 55px rgba(0,0,0,.60);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(255,59,59,.14), transparent 60%),
        radial-gradient(900px 600px at 100% 10%, rgba(255,92,92,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    /* app frame */
    .app{
      width:min(460px, 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background: rgba(0,0,0,.14);
      position:relative;
    }

    /* topbar */
    .topbar{
      position:sticky; top:0;
      padding: calc(14px + env(safe-area-inset-top)) 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(to bottom, rgba(11,11,15,.95), rgba(11,11,15,.70));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.06);
      z-index: 50;
    }
    .left, .right{display:flex;align-items:center;gap:10px}

    .iconbtn{
      width:42px;height:42px;
      display:grid;place-items:center;
      border-radius:999px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      cursor:pointer;
      transition:.2s;
      user-select:none;
    }
    .iconbtn:hover{transform:translateY(-1px); border-color: rgba(255,59,59,.35)}
    .iconbtn:active{transform:translateY(0px); opacity:.9}

    .hamburger{width:18px;height:12px; position:relative}
    .hamburger span{
      position:absolute; left:0; right:0; height:2px;
      background: rgba(255,255,255,.86);
      border-radius: 2px;
    }
    .hamburger span:nth-child(1){top:0}
    .hamburger span:nth-child(2){top:5px;opacity:.9}
    .hamburger span:nth-child(3){top:10px;opacity:.8}

    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      font-weight: 800;
      letter-spacing:.2px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* menu sheet */
    .sheet{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      z-index: 200;
    }
    .sheet.show{display:flex}
    .sheetCard{
      width:100%;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      background: rgba(15,15,20,.98);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      animation: up .18s ease-out;
    }
    @keyframes up{from{transform:translateY(14px);opacity:0}to{transform:none;opacity:1}}
    .sheetTitle{
      display:flex;align-items:center;justify-content:space-between;
      padding: 6px 6px 12px;
      color: rgba(255,255,255,.85);
      font-weight: 800;
    }
    .sheetBtns{display:flex;flex-direction:column;gap:10px}
    .sheetBtn{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      display:flex;align-items:center;justify-content:space-between;
      cursor:pointer;
      transition:.2s;
      font-weight:700;
    }
    .sheetBtn:hover{border-color: rgba(255,59,59,.35)}
    .danger{border-color: rgba(255,59,59,.22)}
    .danger:hover{border-color: rgba(255,59,59,.55)}
    .tiny{
      font-size: 12px;
      color: rgba(255,255,255,.55);
      font-weight:600;
      padding: 6px 6px 0;
      line-height:1.35;
    }

    /* chat */
    .chat{
      flex:1;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .chat::-webkit-scrollbar{width:6px}
    .chat::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:6px}

    .msg{display:flex; width:100%}
    .msg.ai{justify-content:flex-start}
    .msg.user{justify-content:flex-end}

    .bubble{
      max-width: 80%;
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 8px 24px rgba(0,0,0,.34);
      line-height:1.45;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      animation: in .16s ease-out;
      position:relative;
    }
    @keyframes in{from{opacity:0; transform:translateY(6px)}to{opacity:1; transform:none}}

    .ai .bubble{
      background: var(--ai);
      border-bottom-left-radius: 6px;
    }
    .user .bubble{
      background: linear-gradient(135deg, rgba(255,59,59,.92), rgba(255,92,92,.72));
      border-color: rgba(255,59,59,.34);
      border-bottom-right-radius: 6px;
    }

    .meta{
      margin-top: 8px;
      font-size: 12px;
      opacity: .85;
      color: rgba(255,255,255,.75);
    }
    .ai .meta{color: rgba(255,255,255,.60)}
    .time{
      margin-top: 8px;
      font-size: 11px;
      opacity: .65;
    }

    .bubble img{
      max-width:100%;
      border-radius: 14px;
      display:block;
      border: 1px solid rgba(255,255,255,.10);
      margin-top: 10px;
    }

    /* typing bubble */
    .typing{
      display:inline-flex; gap:5px; align-items:center;
      padding: 2px 0;
    }
    .typing i{
      width:6px;height:6px;border-radius:99px;
      background: rgba(255,59,59,.88);
      animation: t 1.1s infinite ease-in-out;
      opacity:.7;
    }
    .typing i:nth-child(2){animation-delay:.12s}
    .typing i:nth-child(3){animation-delay:.24s}
    @keyframes t{0%,80%,100%{transform:scale(.85)}40%{transform:scale(1.15);opacity:1}}

    /* composer */
    .composerWrap{
      position:sticky; bottom:0;
      padding: 10px 12px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(11,11,15,.98), rgba(11,11,15,.70));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.06);
      z-index: 60;
    }
    .composer{
      display:flex;
      align-items:flex-end;
      gap:10px;
      padding:10px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }

    textarea{
      flex:1;
      resize:none;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      line-height:1.35;
      min-height: 24px;
      max-height: 120px;
    }
    textarea::placeholder{color: rgba(255,255,255,.45)}

    .toolbtn{
      width:40px;height:40px;
      border-radius: 999px;
      display:grid;place-items:center;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      transition:.2s;
      flex: 0 0 auto;
      user-select:none;
    }
    .toolbtn:hover{border-color: rgba(255,59,59,.40)}

    .send{
      width:44px;height:44px;
      border-radius: 999px;
      display:grid;place-items:center;
      border:none;
      cursor:pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 26px rgba(255,59,59,.22);
      transition:.2s;
      flex: 0 0 auto;
    }
    .send:disabled{opacity:.5; cursor:not-allowed; box-shadow:none}
    .send:hover:not(:disabled){transform: translateY(-1px)}

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.55);
      margin-top: 8px;
      padding: 0 4px;
      line-height: 1.35;
    }
    .kbd{
      display:inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-weight:700;
      font-size: 11px;
      margin: 0 2px;
    }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 84px;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(20,20,26,.96);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      color: rgba(255,255,255,.9);
      font-weight:700;
      font-size: 12px;
      transition: .18s;
      z-index: 999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    /* dropzone highlight */
    .dropHint{
      position:fixed;
      inset:0;
      background: rgba(255,59,59,.08);
      border: 2px dashed rgba(255,59,59,.35);
      display:none;
      z-index: 150;
    }
    .dropHint.show{display:block}

    /* small */
    @media (max-width: 380px){
      .bubble{max-width: 86%}
      .pill{padding: 9px 12px}
    }

    #imgInput{display:none}
  </style>
</head>
<body>
  <div class="dropHint" id="dropHint"></div>

  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="left">
        <button class="iconbtn" id="btnMenu" title="Menu">
          <div class="hamburger">
            <span></span><span></span><span></span>
          </div>
        </button>
        <div class="pill">ùêëùêöùê≤ùêÜùêèùêì</div>
      </div>
      <div class="right">
        <button class="iconbtn" id="btnNew" title="New chat">‚úé</button>
        <button class="iconbtn" id="btnMore" title="More">‚ãÆ</button>
      </div>
    </div>

    <!-- Chat -->
    <div class="chat" id="chat"></div>

    <!-- Composer -->
    <div class="composerWrap">
      <div class="composer">
        <label class="toolbtn" title="Upload foto">
          üì∑
          <input id="imgInput" type="file" accept="image/*">
        </label>

        <textarea id="text" placeholder="Ask ùêëùêöùê≤ùêÜùêèùêì" rows="1"></textarea>

        <button class="send" id="send" title="Send">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 11.5L21 3l-8.5 18-2.5-7L3 11.5z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="hint">
        <span class="kbd"></span> <span class="kbd"></span><span class="kbd"></span>
        ketik <span class="kbd">/img</span>·¥ú…¥·¥õ·¥ú·¥ã ·¥ç·¥á·¥ç ô·¥ú·¥Ä·¥õ “ì·¥è·¥õ·¥è
      </div>
    </div>
  </div>

  <!-- Sheet Menu -->
  <div class="sheet" id="sheet">
    <div class="sheetCard">
      <div class="sheetTitle">
        <span>ùêëùêöùê≤ùêÜùêèùêì</span>
        <button class="iconbtn" id="btnCloseSheet" title="Close">‚úï</button>
      </div>
      <div class="sheetBtns">
        <button class="sheetBtn" id="btnClear">
          Clear chat
          <span style="opacity:.7">üßπ</span>
        </button>
        <button class="sheetBtn" id="btnExport">
          Export JSON
          <span style="opacity:.7">‚¨áÔ∏è</span>
        </button>
        <button class="sheetBtn danger" id="btnResetAll">
          Reset
          <span style="opacity:.85;color:var(--accent)">‚ö†Ô∏è</span>
        </button>
      </div>
      <div class="tiny">
        ‚Ä¢ Upload foto pakai tombol üì∑ atau drag & drop (desktop)<br/>
        ‚Ä¢ Generate gambar: <b>/img</b> kucing cyber merah neon
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <script>
    const chat = document.getElementById('chat');
    const text = document.getElementById('text');
    const send = document.getElementById('send');
    const imgInput = document.getElementById('imgInput');

    const sheet = document.getElementById('sheet');
    const btnMenu = document.getElementById('btnMenu');
    const btnMore = document.getElementById('btnMore');
    const btnNew = document.getElementById('btnNew');
    const btnCloseSheet = document.getElementById('btnCloseSheet');
    const btnClear = document.getElementById('btnClear');
    const btnExport = document.getElementById('btnExport');
    const btnResetAll = document.getElementById('btnResetAll');

    const toast = document.getElementById('toast');
    const dropHint = document.getElementById('dropHint');

    const STORE_KEY = "valkyz_chat_v1";

    let pendingImageDataUrl = null;
    let history = []; // {role:'user'|'ai', type:'text'|'image', text?, image?, ts}

    /* ---------- utils ---------- */
    function nowTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1600);
    }
    function scrollBottom(){
      chat.scrollTop = chat.scrollHeight;
    }
    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(history));
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(raw) history = JSON.parse(raw) || [];
      }catch{ history = []; }
    }

    function addBubble(role, content, ts){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = content;

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = ts || nowTime();

      bubble.appendChild(time);
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollBottom();
      return bubble;
    }

    function addImage(role, dataUrl, ts){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const img = document.createElement('img');
      img.src = dataUrl;
      img.alt = 'image';
      img.loading = 'lazy';

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = ts || nowTime();

      bubble.appendChild(img);
      bubble.appendChild(time);
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollBottom();
    }

    function addTyping(){
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';
      wrap.id = 'typingRow';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = '<span class="typing"><i></i><i></i><i></i></span>';

      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollBottom();
    }
    function removeTyping(){
      document.getElementById('typingRow')?.remove();
    }

    /* ---------- image compress ---------- */
    async function compressImage(file, maxW = 1024, quality = 0.85){
      const dataUrl = await fileToDataURL(file);
      const img = await loadImage(dataUrl);

      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      // jpeg biar kecil, tapi kalau png/gif bisa tetep png; kita pakai jpeg umum
      return canvas.toDataURL('image/jpeg', quality);
    }

    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const i = new Image();
        i.onload=()=>resolve(i);
        i.onerror=reject;
        i.src=src;
      });
    }

    /* ---------- render initial ---------- */
    function renderAll(){
      chat.innerHTML = "";
      if(history.length === 0){
        // welcome
        addBubble('ai', "Hai! üëã\nApa kabar? Ada yang bisa aku bantu hari ini?", nowTime());
        const meta = document.createElement('div');
        meta.className = 'msg ai';
        meta.innerHTML = `
          <div class="bubble">
            Tips:\n
            ‚Ä¢ Upload foto pakai tombol üì∑\n
            ‚Ä¢ Generate foto: ketik /img + prompt
            <div class="time">${nowTime()}</div>
          </div>
        `;
        chat.appendChild(meta);
        scrollBottom();
        return;
      }

      for(const item of history){
        if(item.type === 'text') addBubble(item.role, item.text, item.ts);
        if(item.type === 'image') addImage(item.role, item.image, item.ts);
      }
      scrollBottom();
    }

    load();
    renderAll();

    /* ---------- input behavior ---------- */
    text.addEventListener('input', () => {
      text.style.height = 'auto';
      text.style.height = Math.min(text.scrollHeight, 120) + 'px';
    });

    text.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSend();
      }
    });

    imgInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      toastMsg("Compressing image...");
      const compressed = await compressImage(file, 1024, 0.85);
      pendingImageDataUrl = compressed;

      // tampilkan di chat
      history.push({ role:'user', type:'text', text:'üì∑ (gambar dikirim)', ts: nowTime() });
      history.push({ role:'user', type:'image', image: compressed, ts: nowTime() });
      save();
      renderAll();

      imgInput.value = '';
    });

    send.addEventListener('click', doSend);

    /* ---------- drag & drop (desktop) ---------- */
    window.addEventListener('dragover', (e)=>{ e.preventDefault(); dropHint.classList.add('show'); });
    window.addEventListener('dragleave', ()=> dropHint.classList.remove('show'));
    window.addEventListener('drop', async (e)=>{
      e.preventDefault();
      dropHint.classList.remove('show');
      const file = e.dataTransfer?.files?.[0];
      if(!file || !file.type.startsWith("image/")) return;
      toastMsg("Compressing dropped image...");
      const compressed = await compressImage(file, 1024, 0.85);
      pendingImageDataUrl = compressed;

      history.push({ role:'user', type:'text', text:'üì∑ (gambar dikirim)', ts: nowTime() });
      history.push({ role:'user', type:'image', image: compressed, ts: nowTime() });
      save();
      renderAll();
    });

    /* ---------- menu sheet ---------- */
    function openSheet(){ sheet.classList.add('show'); }
    function closeSheet(){ sheet.classList.remove('show'); }
    btnMenu.addEventListener('click', openSheet);
    btnMore.addEventListener('click', openSheet);
    btnCloseSheet.addEventListener('click', closeSheet);
    sheet.addEventListener('click', (e)=>{ if(e.target === sheet) closeSheet(); });

    btnNew.addEventListener('click', ()=>{
      history = [];
      pendingImageDataUrl = null;
      save();
      renderAll();
      toastMsg("New chat");
    });

    btnClear.addEventListener('click', ()=>{
      history = [];
      pendingImageDataUrl = null;
      save();
      renderAll();
      toastMsg("Cleared");
      closeSheet();
    });

    btnExport.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(history, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "valkyz-chat-export.json";
      a.click();
      URL.revokeObjectURL(url);
      toastMsg("Exported");
      closeSheet();
    });

    btnResetAll.addEventListener('click', ()=>{
      localStorage.removeItem(STORE_KEY);
      history = [];
      pendingImageDataUrl = null;
      renderAll();
      toastMsg("Reset done");
      closeSheet();
    });

    /* ---------- send ---------- */
    async function doSend(){
      const content = (text.value || '').trim();
      if (!content && !pendingImageDataUrl) return;

      if (content){
        history.push({ role:'user', type:'text', text: content, ts: nowTime() });
      }

      text.value = '';
      text.style.height = 'auto';
      send.disabled = true;
      save();
      renderAll();
      addTyping();

      try{
        const payload = {
          message: content || "",
          image: pendingImageDataUrl
        };

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        removeTyping();

        if (!res.ok) {
          history.push({ role:'ai', type:'text', text: `Error: ${data?.error || 'Unknown error'}`, ts: nowTime() });
          save();
          renderAll();
          return;
        }

        if (data.text){
          history.push({ role:'ai', type:'text', text: data.text, ts: nowTime() });
        }
        if (data.image){
          history.push({ role:'ai', type:'image', image: data.image, ts: nowTime() });
        }

        save();
        renderAll();

      }catch(err){
        removeTyping();
        history.push({ role:'ai', type:'text', text: 'System error. Coba lagi ya.', ts: nowTime() });
        save();
        renderAll();
      }finally{
        pendingImageDataUrl = null;
        send.disabled = false;
        text.focus();
      }
    }
  </script>
</body>
</html>
