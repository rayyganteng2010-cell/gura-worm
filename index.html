<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>WormGPT RAY</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0d;
      --bg2:#0c0c10;
      --panel: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.08);
      --text:#eaeaf2;
      --muted: rgba(255,255,255,.62);

      --red:#ff2a2a;
      --red2:#ff4b4b;

      --bubble:#0f0f14;
      --shadow: 0 18px 55px rgba(0,0,0,.62);
      --glow: 0 0 0 1px rgba(255,42,42,.18), 0 0 22px rgba(255,42,42,.10);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1000px 650px at 30% -10%, rgba(255,42,42,.10), transparent 55%),
        radial-gradient(900px 600px at 100% 20%, rgba(255,75,75,.07), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    .app{
      width:min(460px, 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      position:relative;
      background: rgba(0,0,0,.10);
    }

    .topbar{
      position:sticky; top:0;
      padding: calc(12px + env(safe-area-inset-top)) 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(to bottom, rgba(10,10,13,.92), rgba(10,10,13,.65));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.06);
      z-index: 30;
    }
    .brandPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      font-weight: 800;
      letter-spacing:.2px;
      user-select:none;
    }
    .brandDot{
      width:18px;height:18px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--red2), var(--red));
      box-shadow: 0 0 0 2px rgba(255,42,42,.18), 0 0 18px rgba(255,42,42,.18);
      flex:0 0 auto;
    }
    .topBtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.18s;
      user-select:none;
    }
    .topBtn:hover{transform: translateY(-1px); border-color: rgba(255,42,42,.30)}
    .topRight{display:flex; gap:10px; align-items:center}

    .chat{
      flex:1;
      padding: 14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .chat::-webkit-scrollbar{width:6px}
    .chat::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:6px}

    .row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      width:100%;
    }
    .row.user{
      justify-content:flex-end;
    }

    .avatar{
      width:40px;height:40px;
      border-radius: 999px;
      display:grid;place-items:center;
      flex: 0 0 auto;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .avatar.bot{
      border-color: rgba(255,42,42,.25);
      box-shadow: 0 0 0 1px rgba(255,42,42,.18), 0 10px 26px rgba(0,0,0,.32);
    }

    .bubble{
      max-width: 76%;
      background: rgba(18,18,24,.92);
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(255,42,42,.22);
      box-shadow: var(--glow);
      line-height: 1.42;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .row.user .bubble{
      background: rgba(26,26,34,.78);
      border-color: rgba(255,255,255,.08);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
    }

    .titleLine{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.3px;
      color: var(--red2);
      margin-bottom: 6px;
    }
    .subLine{
      color: rgba(255,255,255,.80);
      font-size: 14px;
      line-height: 1.4;
    }

    .time{
      margin-top: 8px;
      font-size: 11px;
      opacity:.65;
      color: rgba(255,255,255,.55);
    }

    .bubble img{
      display:block;
      max-width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      margin-top: 10px;
    }

    .md p{margin:0 0 8px}
    .md p:last-child{margin-bottom:0}
    .codeBlock{
      margin-top: 10px;
      background: rgba(8,8,12,.95);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
    }
    .codeHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight: 700;
    }
    .copyBtn{
      display:flex; align-items:center; gap:6px;
      border:none;
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,42,42,.10);
      color: rgba(255,255,255,.82);
      border: 1px solid rgba(255,42,42,.22);
      font-weight: 800;
      font-size: 12px;
      transition:.15s;
    }
    .copyBtn:hover{background: rgba(255,42,42,.16); transform: translateY(-1px)}
    pre{
      margin:0;
      padding: 12px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(255,255,255,.92);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre;
    }

    .typing{
      display:inline-flex; gap:5px; align-items:center;
      padding: 2px 0;
    }
    .typing i{
      width:6px;height:6px;border-radius:99px;
      background: rgba(255,42,42,.90);
      animation: t 1.1s infinite ease-in-out;
      opacity:.7;
    }
    .typing i:nth-child(2){animation-delay:.12s}
    .typing i:nth-child(3){animation-delay:.24s}
    @keyframes t{0%,80%,100%{transform:scale(.85)}40%{transform:scale(1.15);opacity:1}}

    .composerWrap{
      position:sticky; bottom:0;
      padding: 10px 12px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(10,10,13,.96), rgba(10,10,13,.70));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.06);
      z-index: 40;
    }
    .composer{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
    }
    textarea{
      flex:1;
      resize:none;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size: 14px;
      line-height: 1.35;
      max-height: 120px;
      min-height: 22px;
    }
    textarea::placeholder{color: rgba(255,255,255,.35)}

    .iconBtn{
      width:44px;height:44px;
      border-radius: 999px;
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      transition:.15s;
      flex: 0 0 auto;
    }
    .iconBtn:hover{border-color: rgba(255,42,42,.35)}
    .sendBtn{
      background: rgba(255,42,42,.16);
      border-color: rgba(255,42,42,.30);
    }
    .sendBtn:hover{background: rgba(255,42,42,.22)}
    .sendBtn:disabled{opacity:.5; cursor:not-allowed}

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.45);
      margin-top: 8px;
      padding: 0 6px;
      line-height: 1.3;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%) translateY(18px);
      opacity: 0;
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(10,10,14,.96);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      color: rgba(255,255,255,.9);
      font-weight:800;
      font-size: 12px;
      transition: .18s;
      z-index: 999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    #imgInput{display:none}

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      opacity: 0;
      pointer-events: none;
      transition: .18s;
      z-index: 80;
    }
    .overlay.show{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      width: min(320px, 86vw);
      background: rgba(12,12,16,.96);
      border-right: 1px solid rgba(255,255,255,.08);
      box-shadow: 20px 0 60px rgba(0,0,0,.65);
      transform: translateX(-105%);
      transition: .22s ease;
      z-index: 90;
      padding: calc(14px + env(safe-area-inset-top)) 14px 14px;
      backdrop-filter: blur(10px);
    }
    .drawer.show{
      transform: translateX(0);
    }

    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom: 12px;
    }
    .drawerTitle{
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(255,75,75,.95);
    }

    .drawerClose{
      width:40px;height:40px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.15s;
    }
    .drawerClose:hover{
      border-color: rgba(255,42,42,.35);
      transform: translateY(-1px);
    }

    .toolList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }

    .toolItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
      transition: .15s;
      user-select:none;
    }
    .toolItem:hover{
      border-color: rgba(255,42,42,.30);
      background: rgba(255,42,42,.10);
      transform: translateY(-1px);
    }
    .toolLeft{
      display:flex; align-items:center; gap:10px;
    }
    .toolIcon{
      width:34px;height:34px;border-radius: 12px;
      display:grid;place-items:center;
      background: rgba(255,42,42,.10);
      border: 1px solid rgba(255,42,42,.22);
    }
    .toolName{
      font-weight: 800;
      font-size: 13px;
    }
    .toolDesc{
      font-size: 12px;
      color: rgba(255,255,255,.60);
      margin-top: 2px;
      line-height: 1.2;
    }
    .toolText{
      display:flex;
      flex-direction:column;
    }

    /* ===== LOGIN OVERLAY ===== */
    .loginOverlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
      padding: 18px;
    }
    .loginCard{
      width: min(420px, 100%);
      border-radius: 18px;
      background: rgba(12,12,16,.96);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 20px 70px rgba(0,0,0,.65);
      padding: 16px;
    }
    .loginTitle{
      font-weight: 900;
      color: rgba(255,75,75,.95);
      font-size: 18px;
      margin-bottom: 6px;
    }
    .loginDesc{
      color: rgba(255,255,255,.68);
      font-size: 13px;
      line-height: 1.35;
      margin-bottom: 12px;
    }
    .loginInput{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      outline: none;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .loginBtn{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,42,42,.18);
      border: 1px solid rgba(255,42,42,.35);
      color: rgba(255,255,255,.9);
      font-weight: 900;
      cursor: pointer;
      transition: .15s;
    }
    .loginBtn:hover{ transform: translateY(-1px); background: rgba(255,42,42,.24); }
    .loginBtn:disabled{ opacity: .6; cursor: not-allowed; transform:none; }
    .loginErr{
      margin-top: 10px;
      color: rgba(255,255,255,.90);
      font-weight: 800;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,42,42,.12);
      border: 1px solid rgba(255,42,42,.25);
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOPBAR -->
    <div class="topbar">
      <button class="topBtn" id="btnMenu" title="Menu">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="brandPill">
        <span class="brandDot"></span>
        <span>WormGPT 0.1 X</span>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.8">
          <path d="M7 10l5 5 5-5" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="topRight">
        <button class="topBtn" id="btnNew" title="New chat">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 20h9" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z"
              stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- CHAT -->
    <div class="chat" id="chat">
      <div class="row bot">
        <div class="avatar bot" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 9v6" stroke="rgba(255,75,75,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M9 12h6" stroke="rgba(255,75,75,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 4l2 3M16 4l-2 3M5 8l3 2M19 8l-3 2M5 16l3-2M19 16l-3-2M8 20l2-3M16 20l-2-3"
              stroke="rgba(255,75,75,.85)" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="12" r="7" stroke="rgba(255,42,42,.35)" stroke-width="2"/>
          </svg>
        </div>

        <div class="bubble">
          <div class="titleLine">Halo!</div>
          <div class="subLine">Terminal akses telah dibuka. Apa perintah Anda?</div>
          <div class="time" id="t0"></div>
        </div>
      </div>
    </div>

    <!-- COMPOSER -->
    <div class="composerWrap">
      <div class="composer">
        <label class="iconBtn" title="Upload photo">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M4 7a2 2 0 0 1 2-2h3l1.2 1.6c.4.5 1 .8 1.6.8h6a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z"
              stroke="rgba(255,255,255,.78)" stroke-width="2" stroke-linejoin="round"/>
            <path d="M8 14l2.2-2.2a1.6 1.6 0 0 1 2.3 0L16 15l1.5-1.5a1.6 1.6 0 0 1 2.3 0L20 14.7"
              stroke="rgba(255,255,255,.78)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="9" cy="10" r="1.2" fill="rgba(255,255,255,.78)"/>
          </svg>
          <input id="imgInput" type="file" accept="image/*">
        </label>

        <textarea id="text" placeholder="Ketik perintah..." rows="1"></textarea>

        <button class="iconBtn sendBtn" id="send" title="Send">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M3 11.5L21 3l-8.5 18-2.5-7L3 11.5z" stroke="rgba(255,75,75,.95)" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="hint">
        Dev <b>@RayyAckerman</b> @rayysuki
      </div>
    </div>

    <div class="toast" id="toast">OK</div>
  </div>

  <!-- OVERLAY + DRAWER -->
  <div class="overlay" id="overlay"></div>

  <aside class="drawer" id="drawerTools" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle">WormGPT</div>
      <button class="drawerClose" id="btnCloseDrawer" title="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="toolList">
      <div class="toolItem" data-href="webtozip.html">
        <div class="toolLeft">
          <div class="toolIcon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M14.7 6.3l3 3M16 4l4 4-9 9H7v-4l9-9z" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="toolText">
            <div class="toolName">Web To App</div>
            <div class="toolDesc">Mengambil File Website</div>
          </div>
        </div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.75">
          <path d="M9 6l6 6-6 6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="toolItem" data-href="nikperse.html">
        <div class="toolLeft">
          <div class="toolIcon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="9" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
              <path d="M12 10v7" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <circle cx="12" cy="7.5" r="1" fill="rgba(255,255,255,.85)"/>
            </svg>
          </div>
          <div class="toolText">
            <div class="toolName">NIK Perse</div>
            <div class="toolDesc">Mencari Data Data Nik</div>
          </div>
        </div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.75">
          <path d="M9 6l6 6-6 6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="toolItem" data-href="foto.html">
        <div class="toolLeft">
          <div class="toolIcon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
              <path d="M19.4 15a7.9 7.9 0 0 0 .1-2l2-1.2-2-3.4-2.3.7a8 8 0 0 0-1.7-1L15 4h-6l-.5 2.1a8 8 0 0 0-1.7 1L4.5 6.4l-2 3.4L4.5 11a7.9 7.9 0 0 0 .1 2l-2 1.2 2 3.4 2.3-.7a8 8 0 0 0 1.7 1L9 20h6l.5-2.1a8 8 0 0 0 1.7-1l2.3.7 2-3.4-2.1-1.2z"
                stroke="rgba(255,255,255,.85)" stroke-width="1.6" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="toolText">
            <div class="toolName">Search Foto</div>
            <div class="toolDesc">Mencari Foto</div>
          </div>
        </div>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.75">
          <path d="M9 6l6 6-6 6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
  </aside>

  <!-- LOGIN OVERLAY -->
  <div class="loginOverlay" id="loginOverlay">
    <div class="loginCard">
      <div class="loginTitle">LOGIN REQUIRED</div>
      <div class="loginDesc">
        <b></b> <br>
         <b></b> <br>
       
      </div>

      <input class="loginInput" id="loginName" placeholder="Username" autocomplete="off" />
      <button class="loginBtn" id="loginBtn">LOGIN</button>

      <div class="loginErr" id="loginErr"></div>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const text = document.getElementById('text');
    const send = document.getElementById('send');
    const imgInput = document.getElementById('imgInput');
    const toast = document.getElementById('toast');
    const btnNew = document.getElementById('btnNew');

    const btnMenu = document.getElementById('btnMenu');
    const overlay = document.getElementById('overlay');
    const drawerTools = document.getElementById('drawerTools');
    const btnCloseDrawer = document.getElementById('btnCloseDrawer');

    function openDrawer(){
      drawerTools.classList.add('show');
      overlay.classList.add('show');
      drawerTools.setAttribute('aria-hidden', 'false');
      text.blur();
    }
    function closeDrawer(){
      drawerTools.classList.remove('show');
      overlay.classList.remove('show');
      drawerTools.setAttribute('aria-hidden', 'true');
    }

    btnMenu.addEventListener('click', openDrawer);
    btnCloseDrawer.addEventListener('click', closeDrawer);
    overlay.addEventListener('click', closeDrawer);

    drawerTools.addEventListener('click', (e)=>{
      const item = e.target.closest('.toolItem');
      if(!item) return;
      const href = item.getAttribute('data-href');
      if(!href) return;
      closeDrawer();
      window.location.href = href;
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') closeDrawer();
    });

    document.getElementById('t0').textContent = timeNow();

    const STORE_KEY = "valkyz_worm_ui_history_v1";
    let history = [];
    let pendingImageDataUrl = null;

    function timeNow(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1500);
    }
    function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }

    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(history));
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(raw) history = JSON.parse(raw) || [];
      }catch{ history = []; }
    }

    function botAvatarSVG(){
      return `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 9v6" stroke="rgba(255,75,75,.95)" stroke-width="2" stroke-linecap="round"/>
        <path d="M9 12h6" stroke="rgba(255,75,75,.95)" stroke-width="2" stroke-linecap="round"/>
        <path d="M8 4l2 3M16 4l-2 3M5 8l3 2M19 8l-3 2M5 16l3-2M19 16l-3-2M8 20l2-3M16 20l-2-3"
          stroke="rgba(255,75,75,.85)" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="12" r="7" stroke="rgba(255,42,42,.35)" stroke-width="2"/>
      </svg>`;
    }

    function userAvatarSVG(){
      return `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M20 21a8 8 0 0 0-16 0" stroke="rgba(255,255,255,.80)" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="9" r="4" stroke="rgba(255,255,255,.80)" stroke-width="2"/>
      </svg>`;
    }

    function createRow(role){
      const row = document.createElement('div');
      row.className = 'row ' + (role === 'user' ? 'user' : 'bot');

      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'user' ? 'user' : 'bot');
      avatar.innerHTML = role === 'user' ? userAvatarSVG() : botAvatarSVG();

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if(role === 'user'){
        row.appendChild(bubble);
        row.appendChild(avatar);
      }else{
        row.appendChild(avatar);
        row.appendChild(bubble);
      }

      chat.appendChild(row);
      return bubble;
    }

    function renderAll(){
      const keep = chat.children[0];
      chat.innerHTML = "";
      chat.appendChild(keep);

      for(const item of history){
        if(item.kind === 'text'){
          const bubble = createRow(item.role);
          bubble.appendChild(renderMarkdownWithCode(item.text, item.role));
          const t = document.createElement('div');
          t.className = 'time';
          t.textContent = item.ts;
          bubble.appendChild(t);
        }else if(item.kind === 'image'){
          const bubble = createRow(item.role);
          const img = document.createElement('img');
          img.src = item.image;
          img.alt = "image";
          img.loading = "lazy";
          bubble.appendChild(img);
          const t = document.createElement('div');
          t.className = 'time';
          t.textContent = item.ts;
          bubble.appendChild(t);
        }
      }
      scrollBottom();
    }

    function renderMarkdownWithCode(textValue, role){
      const root = document.createElement('div');
      root.className = 'md';

      if(role === 'user'){
        root.textContent = textValue;
        return root;
      }

      const blocks = splitByCodeFences(textValue);

      blocks.forEach((b) => {
        if(b.type === 'text'){
          const parts = b.content.split(/\n{2,}/g);
          parts.forEach(p=>{
            const el = document.createElement('p');
            el.textContent = p;
            root.appendChild(el);
          });
        } else {
          const wrap = document.createElement('div');
          wrap.className = 'codeBlock';

          const header = document.createElement('div');
          header.className = 'codeHeader';

          const lang = document.createElement('div');
          lang.textContent = (b.lang || 'code').toUpperCase();

          const btn = document.createElement('button');
          btn.className = 'copyBtn';
          btn.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
              <path d="M9 9h10v12H9V9z" stroke="rgba(255,255,255,.82)" stroke-width="2"/>
              <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1"
                stroke="rgba(255,255,255,.82)" stroke-width="2"/>
            </svg>
            Copy
          `;
          btn.addEventListener('click', async ()=>{
            try{
              await navigator.clipboard.writeText(b.content);
              toastMsg("Copied!");
            }catch{
              toastMsg("Copy failed");
            }
          });

          header.appendChild(lang);
          header.appendChild(btn);

          const pre = document.createElement('pre');
          pre.textContent = b.content;

          wrap.appendChild(header);
          wrap.appendChild(pre);
          root.appendChild(wrap);
        }
      });

      return root;
    }

    function splitByCodeFences(input){
      const re = /```([\w+-]+)?\n([\s\S]*?)```/g;
      let last = 0;
      let m;
      const out = [];
      while((m = re.exec(input)) !== null){
        const before = input.slice(last, m.index);
        if(before.trim()){
          out.push({type:'text', content: before.trim()});
        }
        out.push({type:'code', lang: (m[1]||'').trim(), content: (m[2]||'').replace(/\n+$/,'')});
        last = re.lastIndex;
      }
      const rest = input.slice(last);
      if(rest.trim()){
        out.push({type:'text', content: rest.trim()});
      }
      return out.length ? out : [{type:'text', content: input}];
    }

    function addTyping(){
      const bubble = createRow('bot');
      bubble.id = 'typingBubble';
      bubble.innerHTML = '<span class="typing"><i></i><i></i><i></i></span>';
      scrollBottom();
    }
    function removeTyping(){
      const b = document.getElementById('typingBubble');
      if(b){
        b.parentElement?.remove();
      }
    }

    async function compressImage(file, maxW = 1024, quality = 0.85){
      const dataUrl = await fileToDataURL(file);
      const img = await loadImage(dataUrl);

      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      return canvas.toDataURL('image/jpeg', quality);
    }
    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function loadImage(src){
      return new Promise((resolve, reject)=>{
        const i = new Image();
        i.onload=()=>resolve(i);
        i.onerror=reject;
        i.src=src;
      });
    }

    text.addEventListener('input', () => {
      text.style.height = 'auto';
      text.style.height = Math.min(text.scrollHeight, 120) + 'px';
    });

    text.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSend();
      }
    });

    imgInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      toastMsg("Compressing...");
      const compressed = await compressImage(file);
      pendingImageDataUrl = compressed;

      history.push({role:'user', kind:'image', image: compressed, ts: timeNow()});
      save();
      renderAll();

      imgInput.value = '';
    });

    send.addEventListener('click', doSend);

    btnNew.addEventListener('click', ()=>{
      history = [];
      pendingImageDataUrl = null;
      save();
      renderAll();
      toastMsg("New chat");
      text.blur();
    });

    load();
    renderAll();

    // ===== LOGIN STATE (ipify + vercel verify) =====
    const AUTH_KEY = "rayy_worm_auth_v2";
    let isAuthed = false;
    let authed = null; // { ok:true, name, ip }

    const loginOverlay = document.getElementById("loginOverlay");
    const loginName = document.getElementById("loginName");
    const loginBtn = document.getElementById("loginBtn");
    const loginErr = document.getElementById("loginErr");

    function lockUI(){
      send.disabled = true;
      text.disabled = true;
      imgInput.disabled = true;
    }
    function unlockUI(){
      send.disabled = false;
      text.disabled = false;
      imgInput.disabled = false;
    }

    function showLogin(msg){
      loginOverlay.style.display = "flex";
      loginErr.style.display = msg ? "block" : "none";
      loginErr.textContent = msg || "";
      lockUI();
    }
    function hideLogin(){
      loginOverlay.style.display = "none";
      unlockUI();
    }

    function loadAuth(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj && obj.ok && obj.name && obj.ip){
          isAuthed = true;
          authed = obj;
        }
      }catch{}
    }

    async function getIpFromIpify(){
      const r = await fetch("https://api.ipify.org/?format=json", { cache:"no-store" });
      const j = await r.json();
      return (j.ip || "").trim();
    }

    async function doVerify(name, ip){
      const r = await fetch("/api/verifikasi", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name, ip })
      });
      const j = await r.json().catch(()=> ({}));
      return { status: r.status, body: j };
    }

    async function tryLogin(){
      const name = (loginName.value || "").trim();
      if(!name){
        showLogin("NAMA WAJIB DIISI");
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = "CHECKING...";
      loginErr.style.display = "none";
      loginErr.textContent = "";

      try{
        const ip = await getIpFromIpify();
        if(!ip){
          showLogin("IPIFY GAGAL DETECT IP");
          return;
        }

        const { status, body } = await doVerify(name, ip);

        if(status !== 200 || !body.ok){
          const extra = body?.ip ? `\nIP (ipify): ${ip}\nIP (server): ${body.ip}` : `\nIP (ipify): ${ip}`;
          showLogin((body?.reason || "GAGAL LOGIN") + extra);
          isAuthed = false;
          authed = null;
          localStorage.removeItem(AUTH_KEY);
          return;
        }

        isAuthed = true;
        authed = { ok:true, name: body.user || name, ip };
        localStorage.setItem(AUTH_KEY, JSON.stringify(authed));
        hideLogin();
        toastMsg("LOGIN BERHASIL");
      }catch(e){
        showLogin("ERROR LOGIN: " + (e?.message || e));
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = "LOGIN";
      }
    }

    loginBtn.addEventListener("click", tryLogin);
    loginName.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") tryLogin();
    });

    loadAuth();
    if(!isAuthed){
      showLogin("");
    } else {
      hideLogin();
    }

    async function doSend(){
      if(!isAuthed){
        showLogin("SILAHKAN LOGIN DULU");
        return;
      }

      const content = (text.value || '').trim();
      if (!content && !pendingImageDataUrl) return;

      if(content){
        history.push({role:'user', kind:'text', text: content, ts: timeNow()});
      }

      text.value = '';
      text.style.height = 'auto';
      send.disabled = true;

      save();
      renderAll();

      text.blur();
      addTyping();

      try{
        const auth = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");

        const payload = {
          name: auth?.name || "",
          ip: auth?.ip || "",
          message: content || "",
          image: pendingImageDataUrl
        };

        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));
        removeTyping();

        if(!res.ok){
          if(res.status === 401){
            localStorage.removeItem(AUTH_KEY);
            isAuthed = false;
            authed = null;
            showLogin(data?.error || "SILAHKAN LOGIN ULANG");
            return;
          }
          history.push({role:'bot', kind:'text', text:`Error: ${data?.error || 'Unknown error'}`, ts: timeNow()});
          save(); renderAll();
          return;
        }

        if(data.text){
          history.push({role:'bot', kind:'text', text:data.text, ts: timeNow()});
        }
        if(data.image){
          history.push({role:'bot', kind:'image', image:data.image, ts: timeNow()});
        }

        save();
        renderAll();

      }catch(err){
        removeTyping();
        history.push({role:'bot', kind:'text', text:'System error. Coba lagi ya.', ts: timeNow()});
        save(); renderAll();
      }finally{
        pendingImageDataUrl = null;
        send.disabled = false;
      }
    }
  </script>
</body>
</html>
