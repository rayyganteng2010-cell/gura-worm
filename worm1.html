<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>WormGPT TERMINAL</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #000000;
      --panel: #0a0a0c;
      --primary: #ff003c; /* Cyberpunk Red */
      --primary-dim: rgba(255, 0, 60, 0.2);
      --accent: #00f3ff; /* Cyber Blue for contrast */
      --text: #e0e0e0;
      --text-dim: #6e6e6e;
      --border: rgba(255, 255, 255, 0.1);
      
      --font-ui: 'Inter', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      height: 100dvh; /* Dynamic Height biar ga kepotong di HP */
      width: 100vw;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    /* === LOGIN MATRIX STYLE === */
    .login-wrapper {
      position: fixed; inset: 0; z-index: 9999;
      background: #000;
      display: flex; justify-content: center; align-items: center;
    }
    
    #matrixCanvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0.25; pointer-events: none;
    }

    .login-card {
      position: relative; z-index: 2;
      width: 90%; max-width: 380px;
      padding: 30px;
      background: rgba(10, 10, 12, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid var(--primary-dim);
      border-radius: 4px;
      box-shadow: 0 0 40px rgba(255, 0, 60, 0.15);
      text-align: center;
      animation: cardEnter 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }

    @keyframes cardEnter { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

    .glitch-header {
      font-family: var(--font-code);
      font-weight: 800;
      font-size: 32px;
      color: #fff;
      letter-spacing: -2px;
      margin-bottom: 8px;
      text-shadow: 2px 0 var(--primary);
      position: relative;
    }
    
    .login-desc { color: var(--text-dim); font-size: 13px; margin-bottom: 25px; font-family: var(--font-code); }

    .cyber-input {
      width: 100%;
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--border);
      color: var(--primary);
      padding: 14px;
      font-family: var(--font-code);
      font-size: 16px;
      text-align: center;
      margin-bottom: 15px;
      transition: 0.3s;
      border-radius: 2px;
    }
    .cyber-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-dim); }
    .cyber-input::placeholder { color: #444; }

    .cyber-btn {
      width: 100%;
      background: var(--primary);
      color: #000;
      border: none;
      padding: 14px;
      font-family: var(--font-code);
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      transition: 0.2s;
    }
    .cyber-btn:hover { background: #ff4d73; transform: translateY(-2px); box-shadow: 0 5px 20px var(--primary-dim); }
    .cyber-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .login-error { color: var(--primary); font-size: 12px; margin-top: 15px; font-family: var(--font-code); display: none; }


    /* === MAIN APP LAYOUT (FIXED) === */
    .app {
      width: 100%; max-width: 600px;
      height: 100%; /* Pake 100% dari body yg udh 100dvh */
      background: var(--panel);
      display: flex; flex-direction: column; /* Flex Vertical */
      position: relative;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }

    /* HEADER */
    .header {
      flex: 0 0 auto; /* Tinggi fix, gak berubah */
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(10,10,12,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .brand { font-family: var(--font-code); font-weight: 700; color: #fff; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 8px var(--primary); }
    
    .icon-btn { background: none; border: 1px solid var(--border); color: var(--text); width: 36px; height: 36px; border-radius: 8px; display: grid; place-items: center; cursor: pointer; transition: 0.2s; }
    .icon-btn:hover { border-color: var(--text); background: rgba(255,255,255,0.05); }

    /* CHAT AREA (FILLS SPACE) */
    .chat-container {
      flex: 1; /* Ini kuncinya, dia ngisi sisa ruang */
      overflow-y: auto; /* Scroll cuma di sini */
      padding: 20px;
      display: flex; flex-direction: column; gap: 20px;
      scroll-behavior: smooth;
    }
    .chat-container::-webkit-scrollbar { width: 4px; }
    .chat-container::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

    /* BUBBLES */
    .msg { display: flex; gap: 12px; animation: slideUp 0.3s ease; max-width: 100%; }
    .msg.user { flex-direction: row-reverse; }
    
    .msg-content {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
    }
    .bot .msg-content { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-top-left-radius: 2px; color: #ddd; }
    .user .msg-content { background: var(--primary); color: #000; font-weight: 600; border-top-right-radius: 2px; box-shadow: 0 5px 15px rgba(255, 0, 60, 0.2); }
    
    .msg-avatar { width: 32px; height: 32px; border-radius: 6px; background: #222; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid var(--border); }
    .bot .msg-avatar { border-color: var(--primary); color: var(--primary); }
    
    .msg img { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 1px solid rgba(0,0,0,0.2); }

    /* COMPOSER (BOTTOM FIXED) */
    .composer-area {
      flex: 0 0 auto; /* Jangan sampe ke-squeeze */
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--panel);
      display: flex; align-items: flex-end; gap: 10px;
      z-index: 20;
    }

    .input-box {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex; align-items: flex-end; gap: 10px;
      transition: 0.2s;
    }
    .input-box:focus-within { border-color: var(--primary-dim); box-shadow: 0 0 10px rgba(0,0,0,0.5); }

    textarea {
      flex: 1;
      background: transparent; border: none;
      color: #fff; font-family: var(--font-ui); font-size: 14px;
      resize: none; max-height: 100px; min-height: 20px;
      padding: 0; margin-bottom: 2px;
    }
    textarea::placeholder { color: #555; }

    .send-btn {
      width: 40px; height: 40px; border-radius: 10px;
      background: var(--primary); color: #000;
      border: none; display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0; transition: 0.2s;
    }
    .send-btn:active { transform: scale(0.95); }
    .send-btn:disabled { background: #333; cursor: not-allowed; }

    /* CODE BLOCKS */
    pre { background: #050505; border: 1px solid #222; padding: 10px; border-radius: 6px; overflow-x: auto; margin-top: 8px; }
    code { font-family: var(--font-code); font-size: 12px; color: #0f0; }

    @keyframes slideUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    /* DRAWER MENU */
    .drawer {
      position: fixed; top: 0; left: 0; height: 100%; width: 260px;
      background: #0c0c0e; border-right: 1px solid var(--border);
      transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100; padding: 20px;
    }
    .drawer.active { transform: translateX(0); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s; }
    .overlay.active { opacity: 1; pointer-events: auto; }
    
    .menu-item { display: block; padding: 12px; color: #888; text-decoration: none; font-family: var(--font-code); font-size: 13px; border-radius: 6px; margin-bottom: 5px; transition: .2s; }
    .menu-item:hover { background: rgba(255,255,255,0.05); color: #fff; }

  </style>
</head>
<body>

  <div class="login-wrapper" id="loginWrapper">
    <canvas id="matrixCanvas"></canvas>
    <div class="login-card">
      <div class="glitch-header">WORM GPT</div>
      <div class="login-desc">SECURE TERMINAL ACCESS // v2.0</div>
      
      <input type="text" id="loginName" class="cyber-input" placeholder="ENTER IDENTITY" autocomplete="off" spellcheck="false">
      <button id="btnLogin" class="cyber-btn">INITIALIZE CONNECTION</button>
      <div id="loginError" class="login-error">ACCESS DENIED.</div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="brand">
        <button id="btnMenu" class="icon-btn" style="margin-right:10px; border:none; width:auto; padding:0;">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h8m-8 6h16"/></svg>
        </button>
        <span class="dot"></span>
        RAY-GPT
      </div>
      <button id="btnNew" class="icon-btn" title="Clear Session">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
      </button>
    </header>

    <div class="chat-container" id="chat">
      <div class="msg bot">
        <div class="msg-avatar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 14a1 1 0 110-2 1 1 0 010 2zm1-5h-2v-5h2v5z"/></svg>
        </div>
        <div class="msg-content">
          System online. Enkripsi aktif. <br>Apa perintahmu hari ini?
        </div>
      </div>
    </div>

    <div class="composer-area">
      <div class="input-box">
        <label style="cursor:pointer">
          <svg width="20" height="20" fill="none" stroke="#666" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <input type="file" id="imgInput" hidden accept="image/*">
        </label>
        <textarea id="msgInput" rows="1" placeholder="Execute command..."></textarea>
      </div>
      <button id="sendBtn" class="send-btn">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <nav class="drawer" id="drawer">
    <div style="font-family:var(--font-code); font-weight:800; color:#fff; margin-bottom:20px; font-size:18px;">TOOLS_V1</div>
    <a href="webtozip.html" class="menu-item">> Web Cloner</a>
    <a href="nikperse.html" class="menu-item">> Data Parser</a>
    <a href="foto.html" class="menu-item">> Image Intel</a>
  </nav>

  <script>
    // === MATRIX RAIN EFFECT ===
    const canvas = document.getElementById('matrixCanvas');
    const ctx = canvas.getContext('2d');

    function resizeMatrix() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeMatrix();
    window.addEventListener('resize', resizeMatrix);

    const chars = "010101 WORM RAY GPT HACK SYSTEM DATA 0101";
    const charArray = chars.split("");
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = [];

    for (let i = 0; i < columns; i++) drops[i] = 1;

    function drawMatrix() {
      ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0F0"; // Green Matrix
      ctx.font = fontSize + "px monospace";

      for (let i = 0; i < drops.length; i++) {
        const text = charArray[Math.floor(Math.random() * charArray.length)];
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      }
    }
    setInterval(drawMatrix, 35);

    // === LOGIC APLIKASI ===
    const KEYS = { AUTH: 'worm_auth_final', SESSION: 'worm_sess' };
    const UI = {
      login: document.getElementById('loginWrapper'),
      loginName: document.getElementById('loginName'),
      loginBtn: document.getElementById('btnLogin'),
      loginErr: document.getElementById('loginError'),
      chat: document.getElementById('chat'),
      input: document.getElementById('msgInput'),
      send: document.getElementById('sendBtn'),
      img: document.getElementById('imgInput'),
      drawer: document.getElementById('drawer'),
      overlay: document.getElementById('overlay'),
      menu: document.getElementById('btnMenu'),
      newChat: document.getElementById('btnNew')
    };

    let state = {
      user: null,
      pendingImg: null,
      sessionId: null
    };

    // Auto-resize textarea biar ga overflow
    UI.input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      if(this.value === '') this.style.height = 'auto';
    });

    // Check Auth
    function checkAuth() {
      const stored = localStorage.getItem(KEYS.AUTH);
      if(stored) {
        state.user = JSON.parse(stored);
        UI.login.style.display = 'none';
      }
    }

    // Login Action
    UI.loginBtn.onclick = async () => {
      const name = UI.loginName.value.trim();
      if(!name) return;
      
      UI.loginBtn.innerText = "AUTHENTICATING...";
      UI.loginBtn.disabled = true;

      try {
        const r = await fetch('https://api.ipify.org/?format=json');
        const j = await r.json();
        
        state.user = { name, ip: j.ip };
        localStorage.setItem(KEYS.AUTH, JSON.stringify(state.user));
        
        setTimeout(() => {
          UI.login.style.opacity = '0';
          setTimeout(() => UI.login.style.display = 'none', 500);
        }, 800);
      } catch(e) {
        UI.loginErr.innerText = "NETWORK ERROR";
        UI.loginErr.style.display = 'block';
        UI.loginBtn.disabled = false;
        UI.loginBtn.innerText = "RETRY";
      }
    }

    // Chat Logic
    function addBubble(txt, type, imgData) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'msg-avatar';
      avatar.innerHTML = type === 'bot' 
        ? `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 14a1 1 0 110-2 1 1 0 010 2zm1-5h-2v-5h2v5z"/></svg>`
        : `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;

      const content = document.createElement('div');
      content.className = 'msg-content';
      
      if(type === 'bot') {
        content.innerHTML = parseMarkdown(txt); // Simple parser
      } else {
        content.textContent = txt;
      }

      if(imgData) {
        const i = document.createElement('img');
        i.src = imgData;
        content.appendChild(i);
      }

      if(type === 'user') {
        div.appendChild(content);
        div.appendChild(avatar);
      } else {
        div.appendChild(avatar);
        div.appendChild(content);
      }

      UI.chat.appendChild(div);
      UI.chat.scrollTop = UI.chat.scrollHeight;
      return content;
    }

    function parseMarkdown(text) {
      if(!text) return "";
      let html = text
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      return html;
    }

    async function sendMsg() {
      const txt = UI.input.value.trim();
      if(!txt && !state.pendingImg) return;

      addBubble(txt, 'user', state.pendingImg);
      UI.input.value = '';
      UI.input.style.height = 'auto';
      
      const loading = addBubble("Processing...", 'bot');
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            name: state.user.name,
            ip: state.user.ip,
            message: txt,
            image: state.pendingImg,
            sessionId: state.sessionId
          })
        });
        
        const data = await res.json();
        
        if(res.status === 401) {
          localStorage.removeItem(KEYS.AUTH);
          location.reload();
          return;
        }

        if(data.sessionId) state.sessionId = data.sessionId;
        
        loading.innerHTML = "";
        typeWriter(loading, data.text || "No response.");
        if(data.image) {
          const i = document.createElement('img');
          i.src = data.image;
          loading.appendChild(i);
        }

      } catch(e) {
        loading.textContent = "Error: " + e.message;
      } finally {
        state.pendingImg = null;
      }
    }

    function typeWriter(el, text) {
        let i = 0;
        // Strip tags for typing effect simply, or just dump html
        // Here we just dump HTML because parsing type effect with HTML is hard
        el.innerHTML = parseMarkdown(text); 
        UI.chat.scrollTop = UI.chat.scrollHeight;
    }

    UI.send.onclick = sendMsg;
    UI.input.onkeydown = (e) => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
    };
    
    // Image Handling
    UI.img.onchange = (e) => {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (ev) => {
        state.pendingImg = ev.target.result;
        UI.input.placeholder = "[Image Attached] Add caption...";
        UI.input.focus();
      }
      r.readAsDataURL(f);
    }

    // Drawer
    UI.menu.onclick = () => { UI.drawer.classList.add('active'); UI.overlay.classList.add('active'); }
    UI.overlay.onclick = () => { UI.drawer.classList.remove('active'); UI.overlay.classList.remove('active'); }
    
    // Clear Chat
    UI.newChat.onclick = () => {
      UI.chat.innerHTML = '';
      state.sessionId = null;
      addBubble("Session Reset.", "bot");
    }

    checkAuth();
  </script>
</body>
</html>
